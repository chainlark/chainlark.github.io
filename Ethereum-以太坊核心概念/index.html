
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-L2N33BB7DE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-L2N33BB7DE');
</script>

        
        

        <title>以太坊核心概念</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=2.0">
<link rel="shortcut icon", href="/assets/favicon.ico">
<link rel="apple-touch-icon", href="/assets/apple-touch-icon.png">



   <link type="text/css" rel="stylesheet" href="/css/style.87961c7a2f39f24a3631.css">

   <link type="text/css" rel="stylesheet" href="/css/style.10dc8572fa9e9ecff05b.css">
 
        
    
    <link rel='stylesheet' href="/./css/dracula.css">

    <meta name="generator" content="Hexo 5.2.0"></head>
    <body>
        <header class="al_header al_pos_fixed">
    <div class="al_header_container dis_flex_jcenter">
        <div class="al_header_container_left">
            <div class="al_header_site_title">
                <a href="/">ChainLark | 链晓</a>
            </div>
        </div>

        <div class="dis_flex_jcenter">
            <div class="al_header_setting">
                <svg class="al_header_icon">
                    <use xmlns="http://www.w3.org/2000/svg" xlink:href="/assets/svg_icons.svg#svg-menu"></use>
                </svg>
            </div>
        </div>
    </div>
</header>

        <div class="al_sidebar">

    <div class="al_sidebar_overlay al_full_cover"></div>

    <div class="al_pos_fixed al_sidebar_cnt">
        <div class="dis_flex_acenter al_sidebar_header">
            <h3>ChainLark | 链晓</h3>
            <div class="al_sidebar_close al_header_setting">
                <svg class="al_header_icon">
                    <use xmlns="http://www.w3.org/2000/svg" xlink:href="/assets/svg_icons.svg#svg-close"></use>
                </svg>
            </div>
        </div>

        <div class="al_sidebar_author_cnt">

            <!-- <div class="al_sidebar_author_info">
                <h4>chainlark</h4>
                <img class="al_sidebar_avatar" src="">
                <p></p>
            </div> -->

            
        </div>
    </div>
</div>


        
    <div class="dis_flex_center al_lightbox_cnt al_full_cover">
        <img class="al_lightbox_img"/>
    </div>
    <div class="al_page_background dis_flex_center al_full_cover"></div>
    <div class="al_page_container">
        <div class="al_pos_ab al_fake_background"></div>
        <div class="al_main_container al_shadow al_main_page_container">
            <article class="al_article">
                <header>
                    <h1 class="al_page_title">
                        以太坊核心概念
                    </h1>
                    <div class="al_page_info dis_flex">
                        <div class="al_page_content_info">
                            2020-12-03
                        </div>

                        
                            <div class="al_page_content_info">
                               共 3.1k 词
                            </div>
                        

                        
                            <div class="al_page_content_info">
                               大约需要 10 分钟阅读
                            </div>
                        
                        <span class="tags"></span>
                    </div>
                </header>

                
                    <div class="al_page_content_outline">
                        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A6%E6%88%B7%E7%B1%BB%E5%9E%8B-Accounts"><span class="toc-text">账户类型 (Accounts)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%96%E7%95%8C%E7%8A%B6%E6%80%81-World-State"><span class="toc-text">世界状态 (World State)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E6%98%93-Transaction"><span class="toc-text">交易 (Transaction)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%BA%E5%9D%97-Block"><span class="toc-text">区块 (Block)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%84%E7%BB%87%E6%96%B9%E5%BC%8F"><span class="toc-text">数据组织方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-text">参考文献</span></a></li></ol>
                    </div>
                

                
                <section id="post-body">
                    <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>以太坊可以看做是一台巨大的计算机，人们输入（发送交易），执行逻辑（智能合约执行），并将数据进行存储（世界状态）然后输出结果（回执）。如果用状态机的思想进行类比的话，以太坊就是一个不断变化的状态机，重初始状态（创世状态）开始，通过不断地输入（交易）进行状态变化，上述过程可以简单地用下图示意：</p>
<p><img src="https://chainlark.oss-cn-beijing.aliyuncs.com/6lrcj.jpg" alt="Ethereum as a state transition machine"></p>
<p>在状态机模型中，状态$\sigma_t$和${\sigma_{t+1}}$分别是两个不同的状态，交易 $T$ 是将状态${\sigma_t}$变迁到了${\sigma_{t+1}}$。</p>
<p>在以太坊中，所有的状态变化其实都是由交易引发的，但是如果每一笔交易都需要进行一次状态检查以确认所有的参与节点都正常变迁的话，成本太高了，所以人们想到，把一批交易作为一个检查单元，一批交易处理完之后，检查变化后的总状态，所以引出了区块的概念。其实区块把交易聚合在了一起，并进行广播。一个区块B中包含一批交易$[T_0,T_1,…]$：<br>$$<br>B \equiv (…,(T_0, T_1,…))<br>$$<br>现在以区块为单位进行交易处理以及状态更新，并进行状态检查，那么我们可以得到：<br>$$<br>\sigma_{t +1} \equiv \prod(\sigma_t,B)<br>$$</p>
<ul>
<li>$\sigma_t + 1$ 下一个新的世界状态</li>
<li>$\prod$ 是区块级别的状态转换函数</li>
<li>$\sigma_t$ 是当前的世界状态</li>
<li>$B$ 是一个包含一批交易的区块</li>
</ul>
<h2 id="账户类型-Accounts"><a href="#账户类型-Accounts" class="headerlink" title="账户类型 (Accounts)"></a>账户类型 (Accounts)</h2><p>以太坊中有两种类型的账户：</p>
<ul>
<li>外部权属账户（Externally Owned Accounts 简称 EOA）</li>
<li>合约账户</li>
</ul>
<p>我们平时用来互相收发以太币、部署智能合约的账户就是 外部所有账户账户，而部署智能合约时自动生成的账户则是合约账户。</p>
<blockquote>
<p>合约账户通常是部署的时候生成的，其账户地址的生成同部署者的nonce值有关。</p>
</blockquote>
<p>每一个账户都有账户状态（Account State），账户状态是有序组织起来的规范化数据结构，它存储了当前账户以太币的余额信息、当前账户发送过的交易数量等信息，其内容包括：</p>
<table>
<thead>
<tr>
<th>简称</th>
<th>描述</th>
<th>可变性</th>
</tr>
</thead>
<tbody><tr>
<td><strong>nonce</strong></td>
<td>从该账户发起的交易数量计数以及该账户进行的合约创建操作计数（转账一次加一，部署一次加一）</td>
<td>可变</td>
</tr>
<tr>
<td><strong>balance</strong></td>
<td>此账户所拥有的以太币数量（以 <a target="_blank" rel="noopener" href="http://ethdocs.org/en/latest/ether.html">Wei</a> 计量）</td>
<td>可变</td>
</tr>
<tr>
<td><strong>storageRoot</strong></td>
<td><em>账户存储树</em>的根节点哈希值（对于外部权属账户EOA而言，该字段为空）</td>
<td>可变</td>
</tr>
<tr>
<td><strong>codeHash</strong></td>
<td>对于合约账户而言，codeHash即此合约账户地址部署的 智能合约代码的哈希值（对于 外部权属 账户而言，该字段为空字符串哈希值）</td>
<td>不可变</td>
</tr>
</tbody></table>
<blockquote>
<p>上述属性除了 codeHash之外都是会变化的，比如，当一个账户向其他账户发送以太币时，除了 账户的余额会改变，nonce也 会相应增加。而 codeHash 是不可变的，这就意味着，如果部署了有漏洞的智能合约，后面也无法修复更新此合约。</p>
</blockquote>
<p>账户存储树（storage-tree）是保存与账户相关联数据的结构，该字段只有合约账户才有，而在 EOA 中， storageRoot 留空，codeHash 则是一串空字符串的哈希值。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1glb1xg413nj30fo070gm2.jpg"></p>
<p style="text-align: center; font-size: 12px; color: #9f9f9f">账户状态与账户存储树<p>

<p>所有智能合约的数据都以 32 字节映射的形式保存在账户存储树中，智能合约的数据存储细节参考<a target="_blank" rel="noopener" href="https://medium.com/coinmonks/a-practical-walkthrough-smart-contract-storage-d3383360ea1b">这篇文章</a></p>
<h2 id="世界状态-World-State"><a href="#世界状态-World-State" class="headerlink" title="世界状态 (World State)"></a>世界状态 (World State)</h2><p>在<strong>账户类型</strong>小节中我们已经知道，账户的表现形式为<code>地址 =&gt; Account State</code>的映射，世界状态就是把全局所有的账户整合起来的概念。</p>
<p>世界状态就是无数账户状态的集合，其数据的组织方式是用树的形式进行组织的，如下图所示：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1glb1xgn5wqj30kx0950tg.jpg" alt="wordstate"></p>
<p style="text-align: center; font-size: 12px; color: #9f9f9f">世界状态树与账户存储<p>

<p>世界状态可以被视作为随着交易的执行而持续更新的全局状态，比如说账户Alice给Bob转账了5个以太币，那么整个世界状态中的两个账户状态发生了改变，整棵树都会发生变化，我们称之为世界状态改变。以太坊就像一个去中心化的计算机，世界状态则是这台电脑的硬盘。以太坊中所有的账户信息都体现在世界状态之中，以树的形式进行组织。如果你想知道某一账户的余额，或者某智能合约当前的状态，就需要通过查询世界状态树来获取该账户的具体状态信息。</p>
<h2 id="交易-Transaction"><a href="#交易-Transaction" class="headerlink" title="交易 (Transaction)"></a>交易 (Transaction)</h2><p>上一小节中的世界状态为我们展现了一个巨大的状态机的数据存储方式，而交易就是帮助这个状态机发生变化的触发机制。</p>
<p>在以太坊中有三种交易：</p>
<ol>
<li><strong>Transfer</strong>: 外部权属账户之间的转账交易；</li>
<li><strong>Invoke</strong>: 发送消息来调用合约的交易（例如，通过发送消息调用来触发 setter 方法，以设置合约中的值）。</li>
<li><strong>Deploy</strong>: 部署合约的交易（该方式创建了合约账户）。</li>
</ol>
<blockquote>
<p>技术层面讲，前两种交易的实现方式是一样的，它们都是通过消息调用来改变账户状态的交易，只不过目标地址一个是 EOA ，一个是合约账户。</p>
</blockquote>
<p>交易由以下部分组成：</p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><strong>nonce</strong></td>
<td>此账户发出的交易序号数</td>
<td>一般来讲，nonce值是客户端赋值的，通常来讲，是为了防止交易重复，如短时间产生两笔相同金额的交易可能会出现歧义</td>
</tr>
<tr>
<td><strong>gasPrice</strong></td>
<td>执行此交易、进行计算时为每单位 gas 所支付的费用（以 Wei 计量）。</td>
<td>单价越高，矿工越愿意帮你执行</td>
</tr>
<tr>
<td><strong>gasLimit</strong></td>
<td>执行此交易时可以使用的最大 gas 数量。</td>
<td>上限盖帽</td>
</tr>
<tr>
<td><strong>to</strong></td>
<td><ol><li>如果此交易用于传送以太币，此处为接收以太币的 EOA 地址。</li><li>如果此交易用于向合约发送消息（例如，调用智能合约中的方法），此处为合约的地址。</li><li>如果此交易用于创建合约，此值为空。</li><ol></td>
<td></td>
</tr>
<tr>
<td><strong>value</strong></td>
<td><ol><li> 如果此交易用于收发以太币，此处为发往接收账户以 Wei 计量的代币数量。 </li><li>如果此交易用于发送对合约的消息调用，此处为向接收此消息智能合约所<a target="_blank" rel="noopener" href="https://medium.com/@rsripathi781/6-payable-functions-in-solidity-smartcontract-ethereum-d2535e346dc1">给付</a>的 Wei 数量。</li><li>如果此交易用于创建合约，此处为合约初始化时账户存放的以 Wei 计量的以太币数量。</td>
<td>有些智能合约是允许接收转账的，所以第2种情况就是将以太币存入合约中的操作</li></ol></td>
</tr>
<tr>
<td><strong>v, r, s</strong></td>
<td>在交易的密码学签名中用到的值，可以用于确定交易的发送方。</td>
<td>数字签名 v,r,s 为签名的表示方式</td>
</tr>
<tr>
<td><strong>data</strong></td>
<td>（只用于价值传输以及向智能合约发送消息调用）发送消息调用时附带的输入数据（例如，假设你想要执行智能合约中的 setter 方法，数据区就应该包括 setter 方法的标识符，以及你想要设定的参数值）。</td>
<td>合约调用参数</td>
</tr>
<tr>
<td><strong>init</strong></td>
<td>用于<a target="_blank" rel="noopener" href="https://medium.com/@hayeah/diving-into-the-ethereum-vm-part-5-the-smart-contract-creation-process-cb7b6133b855">初始化合约</a>的 EVM 代码。</td>
<td><strong>只用于合约创建</strong>, 合约部署构造参数</td>
</tr>
</tbody></table>
<p>区块中所有的交易也是存储在默克尔树中的，交易树的根节点哈希值由区块头保存。</p>
<h2 id="区块-Block"><a href="#区块-Block" class="headerlink" title="区块 (Block)"></a>区块 (Block)</h2><p>区块分为两部分，即区块头和区块体。</p>
<p>区块头就是以太坊中的区块链部分。它保存了前一个区块（也可称为父区块）的哈希值，通过区块头的连接形成了一条由密码学签名背书的链。</p>
<p>区块体包含了<a target="_blank" rel="noopener" href="https://medium.com/blockchannel/life-cycle-of-an-ethereum-transaction-e5c66bae0f6e">当前区块中记录</a>的一系列交易，以及叔块（ommer）区块头列表。如果想要进一步了解叔块，推荐阅读<a target="_blank" rel="noopener" href="https://github.com/ethereum/wiki/wiki/Design-Rationale#uncle-incentivization">这篇文章</a>。</p>
<p><img src="https://chainlark.oss-cn-beijing.aliyuncs.com/ummli.jpg" alt="943c0fb1e7074ecd9e95706a5c117a2c"></p>
<p style="text-align: center; font-size: 12px; color: #9f9f9f">以太坊区块的抽象示意图<p>



<p>区块头的细节信息：</p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><strong>parentHash</strong></td>
<td>前一个区块的区块头哈希值。每个区块都包含前序区块的哈希值，一路可回溯至链上的创世块。这也就是维护数据不会被篡改的结构设计（任何对前序区块的篡改都会影响后续所有区块的哈希值）。</td>
<td></td>
</tr>
<tr>
<td><strong>ommersHash</strong></td>
<td>叔块头以及部分区块体的哈希值</td>
<td></td>
</tr>
<tr>
<td><strong>beneficiary</strong></td>
<td>因为挖到此区块而获得收益的以太坊账户。</td>
<td></td>
</tr>
<tr>
<td><strong>stateRoot</strong></td>
<td>世界状态树的根节点哈希值（在所有交易被执行后）。</td>
<td></td>
</tr>
<tr>
<td><strong>transactionsRoot</strong></td>
<td>交易树根节点的哈希值。这棵树包含了区块体的所有交易。</td>
<td></td>
</tr>
<tr>
<td><strong>receiptsRoot</strong></td>
<td>每当交易执行时，以太坊都会生成对应结果的交易收据。此处就是这个交易收据树的根节点哈希。</td>
<td></td>
</tr>
<tr>
<td><strong>logsBloom</strong></td>
<td><a target="_blank" rel="noopener" href="https://hackernoon.com/probabilistic-data-structures-bloom-filter-5374112a7832">布隆过滤器</a>，用于判断某区块的交易是否产生了某日志（如果对这方面感兴趣，可以查阅 <a target="_blank" rel="noopener" href="https://ethereum.stackexchange.com/questions/3418/how-does-ethereum-make-use-of-bloom-filters/3426#3426">Stack Overflow 的这个答案</a>。这避免了在区块中存储日志信息（节省了大量空间）。</td>
<td></td>
</tr>
<tr>
<td><strong>difficulty</strong></td>
<td>此区块的难度值。这是当前区块挖矿难度的度量值（此处不对此概念的细节和计算作介绍）。</td>
<td></td>
</tr>
<tr>
<td><strong>number</strong></td>
<td>前序区块的总数。这标识了区块链的高度（即区块链上有多少区块）。创世区块的 number 为 0 。</td>
<td></td>
</tr>
<tr>
<td><strong>gasLimit</strong></td>
<td>每一个交易都需要消耗 gas 。gas limit 标识了该区块所记录的所有交易可以使用的 gas 总量。这是限制区块内交易数量的一种手段。</td>
<td></td>
</tr>
<tr>
<td><strong>gasUsed</strong></td>
<td>区块中各条交易所实际消耗的 gas 总量。</td>
<td></td>
</tr>
<tr>
<td>timestamp</td>
<td>区块创建时的 Unix 时间戳。谨记由于以太坊网络去中心化的特性，我们不能信任这个值，特别是撰写智能合约、涉及到时间相关的商业逻辑时不能依靠这个值。</td>
<td></td>
</tr>
<tr>
<td><strong>extraData</strong></td>
<td>能输入任何东西的不定长字节数组。当矿工创建区块时，可以在这个区域添加任何东西。</td>
<td></td>
</tr>
<tr>
<td><strong>mixHash</strong></td>
<td>用于验证一个区块是否被真正记录到链上的哈希值（如果想要真正理解这个概念，建议阅读这篇文章 <a target="_blank" rel="noopener" href="https://github.com/ethereum/wiki/wiki/Ethash">Ethash proof-of-work function </a>）。</td>
<td></td>
</tr>
<tr>
<td><strong>nonce</strong></td>
<td>和 mixHash 一样，用于验证区块是否被真正记录到链上的值。</td>
<td></td>
</tr>
</tbody></table>
<h2 id="数据组织方式"><a href="#数据组织方式" class="headerlink" title="数据组织方式"></a>数据组织方式</h2><p>总体而言，以太坊有四种前缀树：</p>
<ol>
<li>世界状态树 (The world state trie)：包括了从地址到账户状态之间的映射。 世界状态树的根节点哈希值由区块保存（在 stateRoot 字段），它标识了区块创建时的当前状态。整个网络中只有一个世界状态树。</li>
<li>账户存储树 (The account storage trie)：保存了与某一智能合约相关的数据信息。由账户状态保存账户存储树的根节点哈希值（在 storageRoot 字段）。每个账户都有一个账户存储树。</li>
<li>交易树 (The transaction trie)：包含了一个区块中的所有交易信息。由区块头（在 transactionsRoot 区域）保存交易树的根节点哈希值。每个区块都有一棵交易树。</li>
<li>交易收据树 (The transaction receipt trie)：包含了一个区块中所有交易的收据信息。同样由区块头（在 receiptsRoot 区域）保存交易收据树的根节点哈希值；每个区块都有对应的交易收据树。</li>
</ol>
<p>以太坊的数据组织可以以下图所示进行解释：</p>
<p><img src="https://chainlark.oss-cn-beijing.aliyuncs.com/vq02j.jpg" alt="img"></p>
<p style="text-align: center; font-size: 12px; color: #9f9f9f">区块、交易、账户状态对象以及以太坊的默克尔树<p>


<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.lucassaldanha.com/ethereum-yellow-paper-walkthrough-1/">https://www.lucassaldanha.com/ethereum-yellow-paper-walkthrough-1/</a></li>
<li><a target="_blank" rel="noopener" href="https://ethfans.org/posts/ethereum-explained-merkle-trees-world-state-transactions-and-more">https://ethfans.org/posts/ethereum-explained-merkle-trees-world-state-transactions-and-more</a></li>
<li><a target="_blank" rel="noopener" href="https://ethereum.stackexchange.com/questions/27432/what-is-nonce-in-ethereum-how-does-it-prevent-double-spending">https://ethereum.stackexchange.com/questions/27432/what-is-nonce-in-ethereum-how-does-it-prevent-double-spending</a></li>
</ol>

                </section>

                
                
                

            </article>

            
            <nav class="dis_flex al_post_nav">
                <a class="al_post_nav_item dis_flex_acenter" href="/">
                    
                </a>
                <a class="al_post_nav_item dis_flex_acenter" href="/">
                    
                </a>
            </nav>
        </div>
    </div>



        <div class="al_index_footer dis_flex_center">
    <div class="al_index_footer_item al_index_footer_title">

    </div>

    
    

    <div class="al_index_footer_item al_index_footer_extra">
    </div>

    <div class="al_index_footer_item al_index_footer_extra_right">
        All Right Reserved
    </div>
</div>

        <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
        </script>
        <!-- webpack injection location -->
        
        <script type="text/javascript" async="async" src="/js/21de460410759395277c.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/27cdd7a8239fa6575fef.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/aeaf7da520f5e4181c2d.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/f00e5401fd5f2e4b28c6.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/46bd7cd04aa167507f7c.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/b9bfe22d868ae9292a2d.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/4f890f6b91f5f0b12610.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/11616649472c7d3966bc.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/d2dea8d2d94d16e656e0.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/a26321d11cf77b9bea8b.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/f0f88db0f1cabada619c.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/f616c8cd578d9f6a1142.chunk.js"></script>
        
        <script type="text/javascript" async="async" src="/js/main.js"></script>
        
        <script type="text/javascript" async="async" src="/js/index.js"></script>
        
        
    </body>
</html>
        